<!-- This rmd imports the population flow chart data (`input_all_flow_chart.csv`) then sequentially drops each of the variables that appears in the population definition logic and counts the remaining population to provide numbers for a flowchart to show inclusion/exclusion of patients in the study. -->

---
title: "Study definition flow chart" 
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(echo = FALSE)
```


$~$


```{r, echo = FALSE, warning= FALSE, message= FALSE}
# Preliminaries ----

## Import libraries ----
library(tidyverse)
library(magrittr)
library(Gmisc)
library(glue)
library(crayon)
library(grid)

## Import data ----
data_flow_chart <- read_csv(
  here::here("output", "input_over80s_flow_chart.csv"),
  col_types = cols(
    
    # identifiers
    patient_id = col_integer(),

    # study criteria
    has_died = col_logical(),
    registered_at_latest = col_logical(),
    age = col_integer(),
    
    has_follow_up_previous_year = col_logical(),
    
    care_home_type = col_character(),
    
    prior_positive_test_date = col_date(format="%Y-%m-%d"),
    prior_primary_care_covid_case_date = col_date(format="%Y-%m-%d"),
    prior_covidadmitted_date = col_date(format="%Y-%m-%d"),
    
    sex = col_character(),
    imd = col_character(),
    region = col_character(),
    ethnicity = col_character(),
    ethnicity_6_sus = col_character(),

    covid_vax_1_date = col_date(format="%Y-%m-%d"),
    covid_vax_pfizer_1_date = col_date(format="%Y-%m-%d"),
    covid_vax_az_1_date = col_date(format="%Y-%m-%d"),
    unknown_vaccine_brand = col_logical()


  ),
  na = character() # more stable to convert to missing later
)

# Fill in unknown ethnicity from GP records with ethnicity from SUS (secondary care)
data_flow_chart <- data_flow_chart %>%
  mutate(ethnicity = ifelse(ethnicity == "", ethnicity_6_sus, ethnicity)) %>%
  select(-ethnicity_6_sus)
```

### Inclusion/exclusion numbers

$~$

#### Population aged over 80 years, alive and registered with a general practice using TPP software on 7th December 2020
```{r, echo = FALSE}
criteria_1 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE)

criteria_1 %>%
  nrow()
```

$~$

#### At least 1 year of follow-up prior to 7th December 2020
```{r, echo = FALSE}
criteria_2 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE) 
```

Excluded = `r nrow(criteria_1) - nrow(criteria_2)`

```{r, echo = FALSE}
criteria_2 %>%
  nrow()
```

$~$

#### Non care home
```{r, echo = FALSE}
criteria_3 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "") 
```

Excluded = `r nrow(criteria_2) - nrow(criteria_3)`

```{r, echo = FALSE}
criteria_3 %>%
  nrow()
```

$~$

#### No prior evidence of COVID infection
```{r, echo = FALSE}
criteria_4 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "",
         is.na(prior_positive_test_date),
         is.na(prior_primary_care_covid_case_date),
         is.na(prior_covidadmitted_date)
         ) 
```

Excluded = `r nrow(criteria_3) - nrow(criteria_4)`

```{r, echo = FALSE}
criteria_4 %>%
  nrow()
```

$~$

#### Patients with non-missing sex
```{r, echo = FALSE}
criteria_5 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "",
         is.na(prior_positive_test_date),
         is.na(prior_primary_care_covid_case_date),
         is.na(prior_covidadmitted_date),
         sex %in% c("F", "M")) 
```

Excluded = `r nrow(criteria_4) - nrow(criteria_5)`

```{r, echo = FALSE}
criteria_5 %>%
  nrow()
```

$~$

#### Patients with non-missing IMD
```{r, echo = FALSE}
criteria_6 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "",
         is.na(prior_positive_test_date),
         is.na(prior_primary_care_covid_case_date),
         is.na(prior_covidadmitted_date),
         sex %in% c("F", "M"),
         imd > 0) 
```

Excluded = `r nrow(criteria_5) - nrow(criteria_6)`

```{r, echo = FALSE}
criteria_6 %>%
  nrow()
```

$~$

#### Patients with non-missing region
```{r, echo = FALSE}
criteria_7 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "",
         is.na(prior_positive_test_date),
         is.na(prior_primary_care_covid_case_date),
         is.na(prior_covidadmitted_date),
         sex %in% c("F", "M"),
         imd > 0,
         region != "") 
```

Excluded = `r nrow(criteria_6) - nrow(criteria_7)`

```{r, echo = FALSE}
criteria_7 %>%
  nrow()
```

$~$

#### Patients with non-missing ethnicity
```{r, echo = FALSE}
criteria_8 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "",
         is.na(prior_positive_test_date),
         is.na(prior_primary_care_covid_case_date),
         is.na(prior_covidadmitted_date),
         sex %in% c("F", "M"),
         imd > 0,
         region != "",
         ethnicity != "") 
```

Excluded = `r nrow(criteria_7) - nrow(criteria_8)`

```{r, echo = FALSE}
criteria_8 %>%
  nrow()
```

$~$

#### Patients with non-Pfizer and non-Oxford az vaccine
```{r, echo = FALSE}
criteria_9 <- data_flow_chart %>%
  filter(age >= 80,
         registered_at_latest == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         care_home_type == "",
         is.na(prior_positive_test_date),
         is.na(prior_primary_care_covid_case_date),
         is.na(prior_covidadmitted_date),
         sex %in% c("F", "M"),
         imd > 0,
         region != "",
         ethnicity != "",
         unknown_vaccine_brand == "FALSE") 
```

Excluded = `r nrow(criteria_8) - nrow(criteria_9)`

```{r, echo = FALSE}
criteria_9 %>%
  nrow()
```

$~$


### Inclusion/exclusion chart

$~$

``` {r, echo = FALSE, warning= FALSE, message= FALSE, fig.width = 8, fig.height = 10}
# The key boxes that we want to plot

## Population alive and registered with a general practice using TPP software on 7th December 2020
criteria1 <- boxGrob(glue_col("Individuals aged over 80 years, \n alive and registered with a general \n practice using TPP software \n on 7 December 2020",
                           "N = {pop}",
                           pop = txtInt(nrow(criteria_1)),
                           .sep = "\n"))

## At least 1 year of follow-up prior to 7th December 2020
exclude1 <- boxGrob(glue_col("<1 year of prior follow-up",
                           "n = {pop}",
                           pop = txtInt(nrow(criteria_1) - nrow(criteria_2)),
                           .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

criteria2 <- boxGrob(glue("At least 1 year of follow-up \n prior to 7 December 2020",
                          "N = {pop}",
                           pop = txtInt(nrow(criteria_2)),
                           .sep = "\n"))

## Non-care home residents
exclude2 <- boxGrob(glue_col("Care home residents",
                           "n = {pop}",
                           pop = txtInt(nrow(criteria_2) - nrow(criteria_3)),
                           .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

criteria3 <- boxGrob(glue("Non-care home residents",
                         "N = {pop}",
                         pop = txtInt(nrow(criteria_3)),
                         .sep = "\n"))

## No prior evidence of COVID infection
exclude3 <- boxGrob(glue_col("Prior evidence of \n COVID infection",
                           "n = {pop}",
                           pop = txtInt(nrow(criteria_3) - nrow(criteria_4)),
                           .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

criteria4 <- boxGrob(glue("No prior evidence of \n COVID infection",
                         "N = {pop}",
                         pop = txtInt(nrow(criteria_4)),
                         .sep = "\n"))

## Patients with non-missing sex, IMD, region and ethnicity 
exclude4 <- boxGrob(glue("Missing data (n = {tot})",
                         " - Sex: {sex}",
                         " - Ethnicity: {eth}",
                         " - IMD: {imd}",
                         " - Region: {region}",
                         tot = txtInt(nrow(criteria_4) - nrow(criteria_8)),
                         sex = txtInt(nrow(criteria_4 %>% filter(!(sex %in% c("F", "M"))))),
                         eth = txtInt(nrow(criteria_4 %>% filter(ethnicity == ""))),
                         imd = txtInt(nrow(criteria_4 %>% filter(imd == 0))),
                         region = txtInt(nrow(criteria_4 %>% filter(region == ""))),
                         .sep = "\n"),
                    txt_gp = gpar(fontsize = 9),
                    just = "left")

criteria5 <- boxGrob(glue("Individuals with non-missing data",
                         "N = {pop}",
                         pop = txtInt(nrow(criteria_8)),
                         .sep = "\n"))

## Patients vaccinated with Pfizer of Oxford AZ brand
exclude5 <- boxGrob(glue_col("Unknown vaccine brand",
                           "n = {pop}",
                           pop = txtInt(nrow(criteria_8) - nrow(criteria_9)),
                           .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

final <- boxGrob(glue("Individuals included in study population",
                         "N = {pop}",
                         pop = txtInt(nrow(criteria_7)),
                      .sep = "\n"))
 
# Move boxes to where we want them
vert <- spreadVertical(criteria1 = criteria1,
                       criteria2 = criteria2,
                       criteria3 = criteria3,
                       criteria4 = criteria4,
                       criteria5 = criteria5,
                       final = final)

exclude1 <- moveBox(exclude1,
                    x = 0.855,
                    y = coords(vert$criteria2)$top +
                      distance(vert$criteria1, vert$criteria2, half = TRUE, center = FALSE))

exclude2 <- moveBox(exclude2,
                    x = 0.855,
                    y = coords(vert$criteria3)$top +
                      distance(vert$criteria2, vert$criteria3, half = TRUE, center = FALSE))

exclude3 <- moveBox(exclude3,
                    x = 0.85,
                    y = coords(vert$criteria4)$top +
                      distance(vert$criteria3, vert$criteria3, half = TRUE, center = FALSE))

exclude4 <- moveBox(exclude4,
                    x = 0.86,
                    y = coords(vert$criteria5)$top +
                      distance(vert$criteria4, vert$criteria3, half = TRUE, center = FALSE))

exclude5 <- moveBox(exclude5,
                    x = 0.855,
                    y = coords(vert$final)$top +
                      distance(vert$criteria5, vert$final, half = TRUE, center = FALSE))

 
# Connect vertical arrows, skip last box
for (i in 1:(length(vert) - 1)) {
  connectGrob(vert[[i]], vert[[i + 1]], type = "vert") %>%
    print
}
 
# Add a connection to the exclusions
connectGrob(vert$criteria1, exclude1, type = "L")
connectGrob(vert$criteria2, exclude2, type = "L")
connectGrob(vert$criteria3, exclude3, type = "L")
connectGrob(vert$criteria4, exclude4, type = "L")
connectGrob(vert$criteria5, exclude5, type = "L")

# Print boxes
vert
exclude1
exclude2
exclude3
exclude4
exclude5
```